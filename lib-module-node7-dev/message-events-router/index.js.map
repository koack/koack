{"version":3,"sources":["../../src/message-events-router/index.js"],"names":["Logger","EventHandlerType","MessageEventType","createEventHandlersMap","logger","handle","ctx","messageEvent","eventHandler","messageCtx","Object","create","assign","context","_context","handler","actions","map","next","ts","subtype","messageType","event","teamId","userId","channelId","destinationType","getChannelType","debug","warn","get"],"mappings":"AACA,OAAOA,MAAP;AACA,SAAcC,qCAAd,EAAgCC,qCAAhC,QAAwD,SAAxD;AACA,OAAOC,sBAAP,MAAmC,0BAAnC;;;;;AAEA,MAAMC,SAAS,IAAIJ,MAAJ,CAAW,6BAAX,CAAf;;AAEA,MAAMK,SAAS,CAACC,GAAD,EAAMC,YAAN,EAAsCC,YAAtC,KAAyE;AAAA,0BAAvD,uBAAuD;;AAAA,0BAAvB,uBAAuB;;AAAA;AAAA;;AACtF,MAAIC,aAAaC,OAAOC,MAAP,CAAcL,GAAd,CAAjB;;AAEAI,SAAOE,MAAP,CAAcH,UAAd,EAA0B;AACxBF,gBADwB;AAExBH,YAAQE,IAAIF,MAAJ,CAAWS,OAAX,mBACHP,IAAIF,MAAJ,CAAWU,QADR;AAENP;AAFM;AAFgB,GAA1B;;AAQAC,eAAaO,OAAb,CAAqBN,UAArB;AACD,CAZD;;AAcA,gBAAe,6BAACO,OAAD,EAAsC;AAAA,qBAA9B,QAAQ,uBAAR,CAA8B;;AAAA;;AACnD,QAAMC,MAAMd,uBAAuBa,OAAvB,CAAZ;;AAEA,SAAO,CAACV,GAAD,EAAMY,IAAN,KAAe;AACpB,UAAM,EAAEC,EAAF,EAAMC,SAASC,WAAf,KAA+Bf,IAAIgB,KAAzC;AACA,QAAI,CAACD,WAAL,EAAkB,OAAOH,MAAP;;AAElB,UAAM,EAAEK,MAAF,EAAUC,MAAV,EAAkBC,SAAlB,KAAgCnB,GAAtC;AACA,UAAMoB,kBAAkBpB,IAAIqB,cAAJ,EAAxB;;AAEAvB,WAAOwB,KAAP,CAAa,eAAb,EAA8B,EAAET,EAAF,EAAMO,eAAN,EAAuBL,WAAvB,EAA9B;AACA,QAAI,CAACK,eAAL,EAAsB;AACpBtB,aAAOyB,IAAP,CAAY,8BAAZ,EAA4C,EAAEH,eAAF,EAA5C;AACA,aAAOR,MAAP;AACD;;AAED,UAAMV,eAAeS,IAAIS,eAAJ,EAAqBI,GAArB,CAAyBT,WAAzB,CAArB;AACA,QAAI,CAACb,YAAL,EAAmB,OAAOU,MAAP;;AAEnB,yBAAkB,uBAAlB,QAAuC,EAAEC,EAAF,EAAMI,MAAN,EAAcC,MAAd,EAAsBC,SAAtB,EAAvC;;AAEApB,WAAOC,GAAP,EAAYC,YAAZ,EAA0BC,YAA1B;AACD,GAnBD;AAoBD,CAvBD","file":"index.js","sourcesContent":["/* @flow */\nimport Logger from 'nightingale-logger/src';\nimport type { EventHandlerType, MessageEventType } from './types';\nimport createEventHandlersMap from './createEventHandlersMap';\n\nconst logger = new Logger('koack:message-events-router');\n\nconst handle = (ctx, messageEvent: MessageEventType, eventHandler: EventHandlerType) => {\n  let messageCtx = Object.create(ctx);\n\n  Object.assign(messageCtx, {\n    messageEvent,\n    logger: ctx.logger.context({\n      ...ctx.logger._context,\n      messageEvent,\n    }),\n  });\n\n  eventHandler.handler(messageCtx);\n};\n\nexport default (actions: Array<EventHandlerType>) => {\n  const map = createEventHandlersMap(actions);\n\n  return (ctx, next) => {\n    const { ts, subtype: messageType } = ctx.event;\n    if (!messageType) return next();\n\n    const { teamId, userId, channelId } = ctx;\n    const destinationType = ctx.getChannelType();\n\n    logger.debug('message event', { ts, destinationType, messageType });\n    if (!destinationType) {\n      logger.warn('Unsupported destination type', { destinationType });\n      return next();\n    }\n\n    const eventHandler = map[destinationType].get(messageType);\n    if (!eventHandler) return next();\n\n    const messageEvent: MessageEventType = { ts, teamId, userId, channelId };\n\n    handle(ctx, messageEvent, eventHandler);\n  };\n};\n"]}