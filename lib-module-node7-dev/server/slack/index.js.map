{"version":3,"sources":["../../../src/server/slack/index.js"],"names":["create","InstallInfoType","client","scopes","callbackUrl","redirectUrl","callback","oauth2","id","clientID","secret","clientSecret","auth","tokenHost","tokenPath","authorizePath","authorize","ctx","redirect","authorizationCode","authorizeURL","redirect_uri","request","origin","scope","state","result","clientCredentials","getToken","code","query","ok","body","team_id","teamId","team_name","teamName","user_id","userId","access_token","accessToken","bot","bot_user_id","botUserId","bot_access_token","botAccessToken","date","Date","team","name","user","installInfo"],"mappings":"AACA,SAASA,MAAT,QAAuB,eAAvB;AACA,SAAcC,mCAAd,QAAqC,mBAArC;;;;AAEA,oCAAgB,cACd,qBAAQ,cAAG,uBAAU,UAAV,CAAH,EAAqB,2BAAc,UAAd,CAArB,CAAR,CADc,EAEd,qBAAQ,QAAM,UAAN,CAAR,CAFc,EAGd,0BAAa,UAAb,CAHc,EAId,0BAAa,UAAb,CAJc,EAKd,uBAAU,W,iBAAC,sB,CAAD,WAAqB,kBAAK,iBAAQ,QAAR,CAAL,CAArB,EAAV,CALc,CAAhB;;;AAQA,gBAAe,qBAMC;AAAA,MANA;AACdC,UADc;AAEdC,UAFc;AAGdC,kBAAc,WAHA;AAIdC,kBAAc,UAJA;AAKdC;AALc,GAMA,GAAf,QAAe;;AACd,QAAMC,SAASP,OAAO;AACpBE,YAAQ;AACNM,UAAIN,OAAOO,QADL;AAENC,cAAQR,OAAOS;AAFT,KADY;AAKpBC,UAAM;AACJC,iBAAW,mBADP;AAEJC,iBAAW,mBAFP;AAGJC,qBAAe;AAHX;AALc,GAAP,CAAf;;AAYA,SAAO;AACLC,eAAYC,GAAD,IAAS;AAClBA,UAAIC,QAAJ,CAAaX,OAAOY,iBAAP,CAAyBC,YAAzB,CAAsC;AACjD;AACAC,sBAAe,GAAEJ,IAAIK,OAAJ,CAAYC,MAAO,GAAEnB,WAAY,EAFD;AAGjDoB,eAAOrB,MAH0C;AAIjDsB,eAAO;AAJ0C,OAAtC,CAAb;AAMD,KARI;;AAULnB,cAAU,MAAOW,GAAP,IAAe;AACvB,YAAMS,SAAS,MAAMnB,OAAOoB,iBAAP,CAAyBC,QAAzB,CAAkC;AACrDC,cAAMZ,IAAIa,KAAJ,CAAUD,IADqC;AAErD;AACAR,sBAAe,GAAEJ,IAAIK,OAAJ,CAAYC,MAAO,GAAEnB,WAAY;AAHG,OAAlC,CAArB;;AAOA,UAAI,CAACsB,MAAD,IAAW,CAACA,OAAOK,EAAvB,EAA2B;AACzBd,YAAIe,IAAJ,GAAW,OAAX;AACD;;AAED,YAAM;AACJC,iBAASC,MADL;AAEJC,mBAAWC,QAFP;AAGJC,iBAASC,MAHL;AAIJC,sBAAcC,WAJV;AAKJC,aAAK;AACHC,uBAAaC,SADV;AAEHC,4BAAkBC;AAFf;AALD,UASFnB,MATJ;;AAWA,0BAAiB,sBAAjB,QAAqC;AACnCoB,cAAM,IAAIC,IAAJ,EAD6B;AAEnC5C,cAFmC;AAGnC6C,cAAM,EAAExC,IAAI0B,MAAN,EAAce,MAAMb,QAApB,EAH6B;AAInCc,cAAM,EAAE1C,IAAI8B,MAAN,EAAcE,WAAd,EAJ6B;AAKnCC,aAAK,EAAEjC,IAAImC,SAAN,EAAiBH,aAAaK,cAA9B;AAL8B,OAArC;;AAQA,UAAIvC,QAAJ,EAAc,MAAMA,SAAS6C,WAAT,CAAN;;AAEdlC,UAAIC,QAAJ,CAAab,WAAb;AACD;AA5CI,GAAP;AA8CD,CAjED","file":"index.js","sourcesContent":["/* @flow */\nimport { create } from 'simple-oauth2';\nimport type { InstallInfoType } from '../../types/index';\n\ntype ArgsType = {|\n  client: {| clientID: string, clientSecret: string |},\n  scopes: Array<string>,\n  callbackUrl: string,\n  redirectUrl: string,\n  callback: (InstallInfoType) => void|Promise<void>,\n|};\n\nexport default ({\n  client,\n  scopes,\n  callbackUrl = '/callback',\n  redirectUrl = '/success',\n  callback,\n}: ArgsType) => {\n  const oauth2 = create({\n    client: {\n      id: client.clientID,\n      secret: client.clientSecret,\n    },\n    auth: {\n      tokenHost: 'https://slack.com',\n      tokenPath: '/api/oauth.access',\n      authorizePath: '/oauth/authorize',\n    },\n  });\n\n  return {\n    authorize: (ctx) => {\n      ctx.redirect(oauth2.authorizationCode.authorizeURL({\n        // eslint-disable-next-line camelcase\n        redirect_uri: `${ctx.request.origin}${callbackUrl}`,\n        scope: scopes,\n        state: '<state>',\n      }));\n    },\n\n    callback: async (ctx) => {\n      const result = await oauth2.clientCredentials.getToken({\n        code: ctx.query.code,\n        // eslint-disable-next-line camelcase\n        redirect_uri: `${ctx.request.origin}${callbackUrl}`,\n      });\n\n\n      if (!result || !result.ok) {\n        ctx.body = 'Error';\n      }\n\n      const {\n        team_id: teamId,\n        team_name: teamName,\n        user_id: userId,\n        access_token: accessToken,\n        bot: {\n          bot_user_id: botUserId,\n          bot_access_token: botAccessToken,\n        },\n      } = result;\n\n      const installInfo: InstallInfoType = {\n        date: new Date(),\n        scopes,\n        team: { id: teamId, name: teamName },\n        user: { id: userId, accessToken },\n        bot: { id: botUserId, accessToken: botAccessToken },\n      };\n\n      if (callback) await callback(installInfo);\n\n      ctx.redirect(redirectUrl);\n    },\n  };\n};\n"]}