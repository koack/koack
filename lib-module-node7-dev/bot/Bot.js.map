{"version":3,"sources":["../../src/bot/Bot.js"],"names":["RtmClient","WebClient","CLIENT_EVENTS","Logger","compose","createContextFromEvent","MiddlewareType","TeamType","logger","Bot","constructor","data","Object","assign","use","middleware","debug","name","middlewares","push","on","allMiddlewares","middlewareLength","length","callback","rtm","event","start","RTM","AUTHENTICATED","self","id","debugSuccess","RTM_CONNECTION_OPENED","infoSuccess","process","send","close","removeAllListeners","disconnect","webClient","installerUsersWebClients"],"mappings":"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","file":"Bot.js","sourcesContent":["/* @flow */\nimport { RtmClient, WebClient, CLIENT_EVENTS } from '@slack/client';\nimport Logger from 'nightingale-logger/src';\nimport compose from 'koa-compose';\nimport createContextFromEvent from './context/createContextFromEvent';\nimport type { MiddlewareType } from './types';\nimport type { TeamType } from '../types';\n\ntype BotConstructorArguments = {|\n  team: ?TeamType,\n  rtm: RtmClient,\n  webClient: WebClient,\n  installerUsersWebClients: null | Map<string, WebClient>,\n|};\n\nconst logger = new Logger('koack:bot');\n\nexport default class Bot {\n  team: ?TeamType;\n  rtm: RtmClient;\n  webClient: WebClient;\n  installerUsersWebClients: null | Map<string, WebClient>;\n  middlewares: Array<MiddlewareType> = [];\n  /** bot id in the team */\n  id: ?string;\n  /** bot name in the team */\n  name: ?string;\n\n  constructor(data: BotConstructorArguments) {\n    Object.assign(this, data);\n  }\n\n  use(middleware: MiddlewareType) {\n    logger.debug('use middleware', { name: middleware.name });\n    this.middlewares.push(middleware);\n  }\n\n  on(name: string, ...middlewares: Array<MiddlewareType>) {\n    const allMiddlewares = [...this.middlewares, ...middlewares];\n    logger.debug('register middlewares on event', { name, middlewareLength: allMiddlewares.length });\n    const callback = compose(allMiddlewares);\n    this.rtm.on(name, (event: Object) => {\n      logger.debug('event', { name, event });\n      callback(createContextFromEvent(this, event));\n    });\n  }\n\n  start() {\n    this.rtm.on(CLIENT_EVENTS.RTM.AUTHENTICATED, ({ self }) => {\n      this.id = self.id;\n      this.name = self.name;\n      logger.debugSuccess('authenticated', { id: self.id, name: self.name });\n    });\n    this.rtm.on(CLIENT_EVENTS.RTM.RTM_CONNECTION_OPENED, () => {\n      logger.infoSuccess('connection opened', { id: this.id, name: this.name });\n      if (process.send) process.send('ready');\n    });\n    this.rtm.start();\n    return this;\n  }\n\n  close() {\n    this.rtm.removeAllListeners();\n    this.rtm.disconnect();\n    delete this.rtm;\n    delete this.webClient;\n    delete this.installerUsersWebClients;\n  }\n}\n"]}