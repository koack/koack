{"version":3,"sources":["../../src/pool/index.js"],"names":["logger","Pool","constructor","options","processNextId","processes","Set","teamsToProcess","Map","Object","assign","start","iterator","info","item","installInfo","addTeam","team","sendBotMessage","teamId","data","has","warn","get","sendMessage","close","forEach","process","kill"],"mappings":";;;;;;AAAA;;;;AACA;;;;;;;;AAEA,MAAMA,SAAS,0BAAW,YAAX,CAAf;;AAOe,MAAMC,IAAN,CAAW;;AAOxBC,cAAYC,OAAZ,EAAsC;AAAA,SAJtCC,aAIsC,GAJtB,CAIsB;AAAA,SAHtCC,SAGsC,GAH1B,IAAIC,GAAJ,EAG0B;AAAA,SAFtCC,cAEsC,GAFrB,IAAIC,GAAJ,EAEqB;;AACpCC,WAAOC,MAAP,CAAc,IAAd,EAAoBP,OAApB;AACD;;AAEKQ,OAAN,CAAYC,QAAZ,EAAsB;AAAA;;AAAA;AACpBZ,aAAOa,IAAP,CAAY,wBAAZ;;AAEA;AACA,WAAK,MAAMC,IAAX,IAAmBF,QAAnB,EAA6B;AAC3B,cAAMG,cAAc,MAAMD,IAA1B;AACA,cAAM,+BAAeC,WAAf,CAAN;AACD;AAPmB;AAQrB;;AAEDC,UAAQC,IAAR,EAAc;AACZ,4BAAS,IAAT,EAAeA,IAAf;AACD;;AAEDC,iBAAeC,MAAf,EAA+BC,IAA/B,EAA6C;AAC3C,QAAI,CAAC,KAAKb,cAAL,CAAoBc,GAApB,CAAwBF,MAAxB,CAAL,EAAsC;AACpCnB,aAAOsB,IAAP,CAAY,SAAZ,EAAuB,EAAEH,MAAF,EAAvB;AACA;AACD;;AAED,SAAKZ,cAAL,CAAoBgB,GAApB,CAAwBJ,MAAxB,EAAgCK,WAAhC,CAA4CL,MAA5C,EAAoDC,IAApD;AACD;;AAEDK,UAAQ;AACN,SAAKpB,SAAL,CAAeqB,OAAf,CAAuBC,WAAWA,QAAQC,IAAR,EAAlC;AACD;AApCuB;kBAAL3B,I","file":"index.js","sourcesContent":["import Logger from 'nightingale/src';\nimport startBot from './startBot';\n\nconst logger = new Logger('koack:pool');\n\ntype PoolOptionsType = {|\n  size: number,\n  path: string,\n|};\n\nexport default class Pool {\n  size: number;\n  path: string;\n  processNextId = 1;\n  processes = new Set();\n  teamsToProcess = new Map();\n\n  constructor(options: PoolOptionsType) {\n    Object.assign(this, options);\n  }\n\n  async start(iterator) {\n    logger.info('bot server is starting');\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const item of iterator) {\n      const installInfo = await item;\n      await startBot(this, installInfo);\n    }\n  }\n\n  addTeam(team) {\n    startBot(this, team);\n  }\n\n  sendBotMessage(teamId: number, data: Object) {\n    if (!this.teamsToProcess.has(teamId)) {\n      logger.warn('No team', { teamId });\n      return;\n    }\n\n    this.teamsToProcess.get(teamId).sendMessage(teamId, data);\n  }\n\n  close() {\n    this.processes.forEach(process => process.kill());\n  }\n}\n"]}