{"version":3,"sources":["../../src/message-router/createActionHandlersMap.js"],"names":["logger","actions","map","dm","commands","Map","regexps","channel","group","forEach","action","where","mention","filter","v","handler","middlewares","stop","command","has","get","warn","set","regexp","push"],"mappings":";;;;;;AACA;;;;AACA;;;;;;AAGA,MAAMA,SAAS,gCAAW,8BAAX,CAAf;;kBAae,iCAACC,OAAD,EAAgD;AAC7D,QAAMC,MAAM;AACVC,QAAI,EAAEC,UAAU,IAAIC,GAAJ,EAAZ,EAAuBC,WAAvB,EADM;AAEVC,aAAS,EAAEH,UAAU,IAAIC,GAAJ,EAAZ,EAAuBC,WAAvB,EAFC;AAGVE,WAAO,EAAEJ,UAAU,IAAIC,GAAJ,EAAZ,EAAuBC,WAAvB;AAHG,GAAZ;;AAMAL,UAAQQ,OAAR,CAAiBC,MAAD,IAAwB;AACtC,QAAI,CAACA,OAAOC,KAAZ,EAAmBD,OAAOC,KAAP;AACnB,QAAI,CAACD,OAAOE,OAAZ,EAAqBF,OAAOE,OAAP,GAAiBF,OAAOC,KAAP,CAAaE,MAAb,CAAoBC,KAAKA,MAAM,IAA/B,CAAjB;AACrB,QAAI,CAACJ,OAAOK,OAAZ,EAAqBL,OAAOK,OAAP,GAAiB,0BAAQL,OAAOM,WAAf,CAAjB;AACrB,QAAIN,OAAOO,IAAP,KAAgB,KAApB,EAA2BP,OAAOO,IAAP,GAAc,IAAd;;AAE3BP,WAAOC,KAAP,CAAaF,OAAb,CAAsBE,KAAD,IAAW;AAC9B,YAAMP,WAAWF,IAAIS,KAAJ,EAAWP,QAA5B;AACA,YAAME,UAAUJ,IAAIS,KAAJ,EAAWL,OAA3B;;AAEA,UAAII,OAAON,QAAX,EAAqB;AACnBM,eAAON,QAAP,CAAgBK,OAAhB,CAAyBS,OAAD,IAAqB;AAC3C,cAAId,SAASe,GAAT,CAAaD,OAAb,KAAyBd,SAASgB,GAAT,CAAaF,OAAb,MAA0BR,MAAvD,EAA+D;AAC7DV,mBAAOqB,IAAP,CAAY,iBAAZ,EAA+B,EAAEH,OAAF,EAA/B;AACD;;AAEDd,mBAASgB,GAAT,CAAaT,KAAb,EAAoBW,GAApB,CAAwBJ,OAAxB,EAAiCR,MAAjC;AACD,SAND;AAOD;;AAED,UAAIA,OAAOa,MAAP,IAAiB,CAACb,OAAON,QAA7B,EAAuC;AACrCE,gBAAQkB,IAAR,CAAad,MAAb;AACD;AACF,KAjBD;AAkBD,GAxBD;;AA0BA,SAAOR,GAAP;AACD,C","file":"createActionHandlersMap.js","sourcesContent":["/* @flow */\nimport compose from 'koa-compose';\nimport Logger from 'nightingale-logger/src';\nimport type { ActionType } from './types';\n\nconst logger = new Logger('koack:message-router:actions');\n\ntype ActionHandlersType = {\n  commands: Map<ActionType>,\n  regexps: Array<ActionType>,\n};\n\ntype ActionsMapType = {\n  dm: ActionHandlersType,\n  channel: ActionHandlersType,\n  group: ActionHandlersType,\n}\n\nexport default (actions: Array<ActionType>): ActionsMapType => {\n  const map = {\n    dm: { commands: new Map(), regexps: [] },\n    channel: { commands: new Map(), regexps: [] },\n    group: { commands: new Map(), regexps: [] },\n  };\n\n  actions.forEach((action: ActionType) => {\n    if (!action.where) action.where = ['dm', 'channel', 'group'];\n    if (!action.mention) action.mention = action.where.filter(v => v !== 'dm');\n    if (!action.handler) action.handler = compose(action.middlewares);\n    if (action.stop !== false) action.stop = true;\n\n    action.where.forEach((where) => {\n      const commands = map[where].commands;\n      const regexps = map[where].regexps;\n\n      if (action.commands) {\n        action.commands.forEach((command: string) => {\n          if (commands.has(command) && commands.get(command) !== action) {\n            logger.warn('override action', { command });\n          }\n\n          commands.get(where).set(command, action);\n        });\n      }\n\n      if (action.regexp || !action.commands) {\n        regexps.push(action);\n      }\n    });\n  });\n\n  return map;\n};\n"]}