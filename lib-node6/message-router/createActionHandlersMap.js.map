{"version":3,"sources":["../../src/message-router/createActionHandlersMap.js"],"names":["logger","actions","map","dm","commands","Map","regexps","channel","group","forEach","action","where","mention","filter","v","command","has","get","warn","set","regexp","push","handler","middlewares","stop"],"mappings":";;;;;;AAAA;;;;AACA;;;;;;AAGA,MAAMA,SAAS,gCAAW,8BAAX,CAAf;;kBAae,iCAACC,OAAD,EAAgD;AAC7D,QAAMC,MAAM;AACVC,QAAI,EAAEC,UAAU,IAAIC,GAAJ,EAAZ,EAAuBC,WAAvB,EADM;AAEVC,aAAS,EAAEH,UAAU,IAAIC,GAAJ,EAAZ,EAAuBC,WAAvB,EAFC;AAGVE,WAAO,EAAEJ,UAAU,IAAIC,GAAJ,EAAZ,EAAuBC,WAAvB;AAHG,GAAZ;;AAMAL,UAAQQ,OAAR,CAAiBC,MAAD,IAAwB;AACtC,QAAI,CAACA,OAAOC,KAAZ,EAAmBD,OAAOC,KAAP;AACnB,QAAI,CAACD,OAAOE,OAAZ,EAAqBF,OAAOE,OAAP,GAAiBF,OAAOC,KAAP,CAAaE,MAAb,CAAoBC,KAAKA,MAAM,IAA/B,CAAjB;;AAErBJ,WAAOC,KAAP,CAAaF,OAAb,CAAsBE,KAAD,IAAW;AAC9B,YAAMP,WAAWF,IAAIS,KAAJ,EAAWP,QAA5B;AACA,YAAME,UAAUJ,IAAIS,KAAJ,EAAWL,OAA3B;;AAEA,UAAII,OAAON,QAAX,EAAqB;AACnBM,eAAON,QAAP,CAAgBK,OAAhB,CAAyBM,OAAD,IAAqB;AAC3C,cAAIX,SAASY,GAAT,CAAaD,OAAb,KAAyBX,SAASa,GAAT,CAAaF,OAAb,MAA0BL,MAAvD,EAA+D;AAC7DV,mBAAOkB,IAAP,CAAY,iBAAZ,EAA+B,EAAEH,OAAF,EAA/B;AACD;;AAEDX,mBAASa,GAAT,CAAaN,KAAb,EAAoBQ,GAApB,CAAwBJ,OAAxB,EAAiCL,MAAjC;AACD,SAND;AAOD;;AAED,UAAIA,OAAOU,MAAP,IAAiB,CAACV,OAAON,QAA7B,EAAuC;AACrCE,gBAAQe,IAAR,CAAaX,MAAb;AACD;AACF,KAjBD;;AAmBA,QAAI,CAACA,OAAOY,OAAZ,EAAqBZ,OAAOY,OAAP,GAAiB,0BAAQZ,OAAOa,WAAf,CAAjB;;AAErB,QAAIb,OAAOc,IAAP,KAAgB,KAApB,EAA2B;AACzBd,aAAOc,IAAP,GAAc,IAAd;AACD;AACF,GA5BD;;AA8BA,SAAOtB,GAAP;AACD,C","file":"createActionHandlersMap.js","sourcesContent":["import compose from 'koa-compose';\nimport Logger from 'nightingale-logger/src';\nimport type { ActionType } from '../types';\n\nconst logger = new Logger('koack:message-router:actions');\n\ntype ActionHandlersType = {\n  commands: Map<ActionType>,\n  regexps: Array<ActionType>,\n};\n\ntype ActionsMapType = {\n  dm: ActionHandlersType,\n  channel: ActionHandlersType,\n  group: ActionHandlersType,\n}\n\nexport default (actions: Array<ActionType>): ActionsMapType => {\n  const map = {\n    dm: { commands: new Map(), regexps: [] },\n    channel: { commands: new Map(), regexps: [] },\n    group: { commands: new Map(), regexps: [] },\n  };\n\n  actions.forEach((action: ActionType) => {\n    if (!action.where) action.where = ['dm', 'channel', 'group'];\n    if (!action.mention) action.mention = action.where.filter(v => v !== 'dm');\n\n    action.where.forEach((where) => {\n      const commands = map[where].commands;\n      const regexps = map[where].regexps;\n\n      if (action.commands) {\n        action.commands.forEach((command: string) => {\n          if (commands.has(command) && commands.get(command) !== action) {\n            logger.warn('override action', { command });\n          }\n\n          commands.get(where).set(command, action);\n        });\n      }\n\n      if (action.regexp || !action.commands) {\n        regexps.push(action);\n      }\n    });\n\n    if (!action.handler) action.handler = compose(action.middlewares);\n\n    if (action.stop !== false) {\n      action.stop = true;\n    }\n  });\n\n  return map;\n};\n"]}