{"version":3,"sources":["../../../src/server/slack/index.js"],"names":["client","scopes","callbackUrl","redirectUrl","callback","oauth2","id","clientID","secret","clientSecret","auth","tokenHost","tokenPath","authorizePath","authorize","ctx","redirect","authorizationCode","authorizeURL","redirect_uri","request","origin","scope","state","result","clientCredentials","getToken","code","query","ok","body","team_id","teamId","team_name","teamName","user_id","userId","access_token","accessToken","bot","bot_user_id","botUserId","bot_access_token","botAccessToken","installInfo","date","Date","team","name","user"],"mappings":";;;;;;AACA;;;;kBAWe,CAAC;AACdA,QADc;AAEdC,QAFc;AAGdC,gBAAc,WAHA;AAIdC,gBAAc,UAJA;AAKdC;AALc,CAAD,KAMC;AACd,QAAMC,SAAS,yBAAO;AACpBL,YAAQ;AACNM,UAAIN,OAAOO,QADL;AAENC,cAAQR,OAAOS;AAFT,KADY;AAKpBC,UAAM;AACJC,iBAAW,mBADP;AAEJC,iBAAW,mBAFP;AAGJC,qBAAe;AAHX;AALc,GAAP,CAAf;;AAYA,SAAO;AACLC,eAAYC,GAAD,IAAS;AAClBA,UAAIC,QAAJ,CAAaX,OAAOY,iBAAP,CAAyBC,YAAzB,CAAsC;AACjD;AACAC,sBAAe,GAAEJ,IAAIK,OAAJ,CAAYC,MAAO,GAAEnB,WAAY,EAFD;AAGjDoB,eAAOrB,MAH0C;AAIjDsB,eAAO;AAJ0C,OAAtC,CAAb;AAMD,KARI;;AAULnB;AAAA,mCAAU,WAAOW,GAAP,EAAe;AACvB,cAAMS,SAAS,MAAMnB,OAAOoB,iBAAP,CAAyBC,QAAzB,CAAkC;AACrDC,gBAAMZ,IAAIa,KAAJ,CAAUD,IADqC;AAErD;AACAR,wBAAe,GAAEJ,IAAIK,OAAJ,CAAYC,MAAO,GAAEnB,WAAY;AAHG,SAAlC,CAArB;;AAOA,YAAI,CAACsB,MAAD,IAAW,CAACA,OAAOK,EAAvB,EAA2B;AACzBd,cAAIe,IAAJ,GAAW,OAAX;AACD;;AAED,cAAM;AACJC,mBAASC,MADL;AAEJC,qBAAWC,QAFP;AAGJC,mBAASC,MAHL;AAIJC,wBAAcC,WAJV;AAKJC,eAAK;AACHC,yBAAaC,SADV;AAEHC,8BAAkBC;AAFf;AALD,YASFnB,MATJ;;AAWA,cAAMoB,cAA+B;AACnCC,gBAAM,IAAIC,IAAJ,EAD6B;AAEnC7C,gBAFmC;AAGnC8C,gBAAM,EAAEzC,IAAI0B,MAAN,EAAcgB,MAAMd,QAApB,EAH6B;AAInCe,gBAAM,EAAE3C,IAAI8B,MAAN,EAAcE,WAAd,EAJ6B;AAKnCC,eAAK,EAAEjC,IAAImC,SAAN,EAAiBH,aAAaK,cAA9B;AAL8B,SAArC;;AAQA,YAAIvC,QAAJ,EAAc,MAAMA,SAASwC,WAAT,CAAN;;AAEd7B,YAAIC,QAAJ,CAAab,WAAb;AACD,OAlCD;;AAAA;AAAA;AAAA;AAAA;AAVK,GAAP;AA8CD,C","file":"index.js","sourcesContent":["/* @flow */\nimport { create } from 'simple-oauth2';\nimport type { InstallInfoType } from '../../types/index';\n\ntype ArgsType = {|\n  client: {| clientID: string, clientSecret: string |},\n  scopes: Array<string>,\n  callbackUrl: string,\n  redirectUrl: string,\n  callback: (InstallInfoType) => void|Promise<void>,\n|};\n\nexport default ({\n  client,\n  scopes,\n  callbackUrl = '/callback',\n  redirectUrl = '/success',\n  callback,\n}: ArgsType) => {\n  const oauth2 = create({\n    client: {\n      id: client.clientID,\n      secret: client.clientSecret,\n    },\n    auth: {\n      tokenHost: 'https://slack.com',\n      tokenPath: '/api/oauth.access',\n      authorizePath: '/oauth/authorize',\n    },\n  });\n\n  return {\n    authorize: (ctx) => {\n      ctx.redirect(oauth2.authorizationCode.authorizeURL({\n        // eslint-disable-next-line camelcase\n        redirect_uri: `${ctx.request.origin}${callbackUrl}`,\n        scope: scopes,\n        state: '<state>',\n      }));\n    },\n\n    callback: async (ctx) => {\n      const result = await oauth2.clientCredentials.getToken({\n        code: ctx.query.code,\n        // eslint-disable-next-line camelcase\n        redirect_uri: `${ctx.request.origin}${callbackUrl}`,\n      });\n\n\n      if (!result || !result.ok) {\n        ctx.body = 'Error';\n      }\n\n      const {\n        team_id: teamId,\n        team_name: teamName,\n        user_id: userId,\n        access_token: accessToken,\n        bot: {\n          bot_user_id: botUserId,\n          bot_access_token: botAccessToken,\n        },\n      } = result;\n\n      const installInfo: InstallInfoType = {\n        date: new Date(),\n        scopes,\n        team: { id: teamId, name: teamName },\n        user: { id: userId, accessToken },\n        bot: { id: botUserId, accessToken: botAccessToken },\n      };\n\n      if (callback) await callback(installInfo);\n\n      ctx.redirect(redirectUrl);\n    },\n  };\n};\n"]}