{"version":3,"sources":["../../../src/server/slack/index.js"],"names":["ArgsType","client","clientID","clientSecret","scopes","callbackUrl","redirectUrl","callback","oauth2","id","secret","auth","tokenHost","tokenPath","authorizePath","authorize","ctx","redirect","authorizationCode","authorizeURL","redirect_uri","request","origin","scope","state","result","clientCredentials","getToken","code","query","ok","body","console","log","team_id","teamId","team_name","teamName","user_id","userId","access_token","accessToken","bot","bot_user_id","botUserId","bot_access_token","botAccessToken","installInfo","date","Date","team","name","user"],"mappings":";;;;;;;;;;AACA;;AACA;;;;;;MAEKA,Q;AACHC,Q;AAAWC,Y;AAAkBC,gB;;;;AAC7BC,Q;AACAC,a;AACAC,a;AACAC,U;;;;;;kBAGa,eAAC;AACdN,QADc;AAEdG,QAFc;AAGdC,gBAAc,WAHA;AAIdC,gBAAc,UAJA;AAKdC;AALc,CAAD,EAMC;AAAA;AALdN,UAKc;AAJdG,UAIc;AAHdC,eAGc;AAFdC,eAEc;AADdC;AACc,KAAbP,QAAa;;AACd,QAAMQ,SAAS,yBAAO;AACpBP,YAAQ;AACNQ,UAAIR,OAAOC,QADL;AAENQ,cAAQT,OAAOE;AAFT,KADY;AAKpBQ,UAAM;AACJC,iBAAW,mBADP;AAEJC,iBAAW,mBAFP;AAGJC,qBAAe;AAHX;AALc,GAAP,CAAf;;AAYA,SAAO;AACLC,eAAYC,GAAD,IAAS;AAClBA,UAAIC,QAAJ,CAAaT,OAAOU,iBAAP,CAAyBC,YAAzB,CAAsC;AACjD;AACAC,sBAAe,GAAEJ,IAAIK,OAAJ,CAAYC,MAAO,GAAEjB,WAAY,EAFD;AAGjDkB,eAAOnB,MAH0C;AAIjDoB,eAAO;AAJ0C,OAAtC,CAAb;AAMD,KARI;;AAULjB;AAAA,mCAAU,WAAOS,GAAP,EAAe;AACvB,cAAMS,SAAS,MAAMjB,OAAOkB,iBAAP,CAAyBC,QAAzB,CAAkC;AACrDC,gBAAMZ,IAAIa,KAAJ,CAAUD,IADqC;AAErD;AACAR,wBAAe,GAAEJ,IAAIK,OAAJ,CAAYC,MAAO,GAAEjB,WAAY;AAHG,SAAlC,CAArB;;AAOA,YAAI,CAACoB,MAAD,IAAW,CAACA,OAAOK,EAAvB,EAA2B;AACzBd,cAAIe,IAAJ,GAAW,OAAX;AACD;;AAEDC,gBAAQC,GAAR,CAAYR,MAAZ;AACA,cAAM;AACJS,mBAASC,MADL;AAEJC,qBAAWC,QAFP;AAGJC,mBAASC,MAHL;AAIJC,wBAAcC,WAJV;AAKJC,eAAK;AACHC,yBAAaC,SADV;AAEHC,8BAAkBC;AAFf;AALD,YASFrB,MATJ;;AAWA,cAAMsB,sBAA+B;AACnCC,gBAAM,IAAIC,IAAJ,EAD6B;AAEnC7C,gBAFmC;AAGnC8C,gBAAM,EAAEzC,IAAI0B,MAAN,EAAcgB,MAAMd,QAApB,EAH6B;AAInCe,gBAAM,EAAE3C,IAAI8B,MAAN,EAAcE,WAAd,EAJ6B;AAKnCC,eAAK,EAAEjC,IAAImC,SAAN,EAAiBH,aAAaK,cAA9B;AAL8B,SAA/B,wCAAN;;AAQA,YAAIvC,QAAJ,EAAc,MAAMA,SAASwC,WAAT,CAAN;;AAEd/B,YAAIC,QAAJ,CAAaX,WAAb;AACD,OAnCD;;AAAA;AAAA;AAAA;AAAA;AAVK,GAAP;AA+CD,C","file":"index.js","sourcesContent":["/* @flow */\nimport { create } from 'simple-oauth2';\nimport type { InstallInfoType } from '../../types/index';\n\ntype ArgsType = {|\n  client: {| clientID: string, clientSecret: string |},\n  scopes: Array<string>,\n  callbackUrl: string,\n  redirectUrl: string,\n  callback: (InstallInfoType) => void|Promise<void>,\n|};\n\nexport default ({\n  client,\n  scopes,\n  callbackUrl = '/callback',\n  redirectUrl = '/success',\n  callback,\n}: ArgsType) => {\n  const oauth2 = create({\n    client: {\n      id: client.clientID,\n      secret: client.clientSecret,\n    },\n    auth: {\n      tokenHost: 'https://slack.com',\n      tokenPath: '/api/oauth.access',\n      authorizePath: '/oauth/authorize',\n    },\n  });\n\n  return {\n    authorize: (ctx) => {\n      ctx.redirect(oauth2.authorizationCode.authorizeURL({\n        // eslint-disable-next-line camelcase\n        redirect_uri: `${ctx.request.origin}${callbackUrl}`,\n        scope: scopes,\n        state: '<state>',\n      }));\n    },\n\n    callback: async (ctx) => {\n      const result = await oauth2.clientCredentials.getToken({\n        code: ctx.query.code,\n        // eslint-disable-next-line camelcase\n        redirect_uri: `${ctx.request.origin}${callbackUrl}`,\n      });\n\n\n      if (!result || !result.ok) {\n        ctx.body = 'Error';\n      }\n\n      console.log(result);\n      const {\n        team_id: teamId,\n        team_name: teamName,\n        user_id: userId,\n        access_token: accessToken,\n        bot: {\n          bot_user_id: botUserId,\n          bot_access_token: botAccessToken,\n        },\n      } = result;\n\n      const installInfo: InstallInfoType = {\n        date: new Date(),\n        scopes,\n        team: { id: teamId, name: teamName },\n        user: { id: userId, accessToken },\n        bot: { id: botUserId, accessToken: botAccessToken },\n      };\n\n      if (callback) await callback(installInfo);\n\n      ctx.redirect(redirectUrl);\n    },\n  };\n};\n"]}