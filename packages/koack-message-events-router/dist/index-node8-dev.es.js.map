{"version":3,"file":"index-node8-dev.es.js","sources":["../src/createEventHandlersMap.ts","../src/index.ts"],"sourcesContent":["import compose from 'koa-compose';\nimport { WhereType } from 'koack-types';\nimport { CallbackEventHandler, EventHandler, MiddlewaresEventHandler } from './types';\n\nexport interface EventHandlerMap {\n  [key: string]: Map<string, CallbackEventHandler>;\n}\n\nexport default (actions: Array<EventHandler>): EventHandlerMap => {\n  const map: EventHandlerMap = {\n    dm: new Map(),\n    channel: new Map(),\n    group: new Map(),\n  };\n\n  actions.forEach((eventHandler: EventHandler) => {\n    if (!eventHandler.where) eventHandler.where = ['dm', 'channel', 'group'];\n    if (eventHandler.handler === undefined) {\n      (eventHandler as CallbackEventHandler).handler = compose(\n        (eventHandler as MiddlewaresEventHandler).middlewares,\n      );\n    }\n\n    eventHandler.where.forEach((where: WhereType) => {\n      eventHandler.events.forEach((eventName: string) => {\n        if (map[where].has(eventName)) throw new Error(`event redefined: \"${eventName}\"`);\n        map[where].set(eventName, eventHandler as CallbackEventHandler);\n      });\n    });\n  });\n\n  return map;\n};\n","import Logger from 'nightingale-logger';\nimport { BotContext } from 'koack-bot/src/types';\nimport { CallbackEventHandler, EventHandler, MessageEvent, MessageContext } from './types';\nimport createEventHandlersMap from './createEventHandlersMap';\n\nconst logger = new Logger('koack:message-events-router');\n\nconst handle = (\n  ctx: BotContext,\n  messageEvent: MessageEvent,\n  eventHandler: CallbackEventHandler,\n) => {\n  const messageCtx: MessageContext = Object.create(ctx);\n\n  Object.assign(messageCtx, {\n    messageEvent,\n    logger: ctx.logger.context({\n      ...ctx.logger.getContextObject(),\n      messageEvent,\n    }),\n  });\n\n  eventHandler.handler(messageCtx);\n};\n\nexport default (actions: Array<EventHandler>) => {\n  const map = createEventHandlersMap(actions);\n\n  return (ctx, next) => {\n    const { ts, subtype: messageType } = ctx.event;\n    if (!messageType) return next();\n\n    const { teamId, userId, channelId } = ctx;\n    const destinationType = ctx.getChannelType();\n\n    logger.debug('message event', { ts, destinationType, messageType });\n    if (!destinationType) {\n      logger.warn('Unsupported destination type', { destinationType });\n      return next();\n    }\n\n    const eventHandler = map[destinationType].get(messageType);\n    if (!eventHandler) return next();\n\n    const messageEvent: MessageEvent = { ts, teamId, userId, channelId };\n\n    handle(ctx, messageEvent, eventHandler);\n  };\n};\n"],"names":["actions","map","dm","Map","channel","group","forEach","eventHandler","where","handler","undefined","compose","middlewares","events","eventName","has","Error","set","logger","Logger","handle","ctx","messageEvent","messageCtx","Object","create","assign","context","getContextObject","createEventHandlersMap","next","ts","subtype","messageType","event","teamId","userId","channelId","destinationType","getChannelType","debug","warn","get"],"mappings":";;;AAQA,8BAAgBA,OAAD,IAAmD;QAC1DC,GAAoB,GAAG;IAC3BC,EAAE,EAAE,IAAIC,GAAJ,EADuB;IAE3BC,OAAO,EAAE,IAAID,GAAJ,EAFkB;IAG3BE,KAAK,EAAE,IAAIF,GAAJ;GAHT;EAMAH,OAAO,CAACM,OAAR,CAAiBC,YAAD,IAAgC;QAC1C,CAACA,YAAY,CAACC,KAAlB,EAAyBD,YAAY,CAACC,KAAb,GAAqB,CAAC,IAAD,EAAO,SAAP,EAAkB,OAAlB,CAArB;;QACrBD,YAAY,CAACE,OAAb,KAAyBC,SAA7B,EAAwC;MACrCH,YAAD,CAAuCE,OAAvC,GAAiDE,OAAO,CACrDJ,YAAD,CAA0CK,WADY,CAAxD;;;IAKFL,YAAY,CAACC,KAAb,CAAmBF,OAAnB,CAA4BE,KAAD,IAAsB;MAC/CD,YAAY,CAACM,MAAb,CAAoBP,OAApB,CAA6BQ,SAAD,IAAuB;YAC7Cb,GAAG,CAACO,KAAD,CAAH,CAAWO,GAAX,CAAeD,SAAf,CAAJ,EAA+B,MAAM,IAAIE,KAAJ,CAAW,qBAAoBF,SAAU,GAAzC,CAAN;QAC/Bb,GAAG,CAACO,KAAD,CAAH,CAAWS,GAAX,CAAeH,SAAf,EAA0BP,YAA1B;OAFF;KADF;GARF;SAgBON,GAAP;CAvBF;;ACHA,MAAMiB,MAAM,GAAG,IAAIC,MAAJ,CAAW,6BAAX,CAAf;;AAEA,MAAMC,MAAM,GAAG,CACbC,GADa,EAEbC,YAFa,EAGbf,YAHa,KAIV;QACGgB,UAA0B,GAAGC,MAAM,CAACC,MAAP,CAAcJ,GAAd,CAAnC;EAEAG,MAAM,CAACE,MAAP,CAAcH,UAAd,EAA0B;IACxBD,YADwB;IAExBJ,MAAM,EAAEG,GAAG,CAACH,MAAJ,CAAWS,OAAX,CAAmB,EACzB,GAAGN,GAAG,CAACH,MAAJ,CAAWU,gBAAX,EADsB;MAEzBN;KAFM;GAFV;EAQAf,YAAY,CAACE,OAAb,CAAqBc,UAArB;CAfF;;AAkBA,aAAgBvB,OAAD,IAAkC;QACzCC,GAAG,GAAG4B,sBAAsB,CAAC7B,OAAD,CAAlC;SAEO,CAACqB,GAAD,EAAMS,IAAN,KAAe;UACd;MAAEC,EAAF;MAAMC,OAAO,EAAEC;QAAgBZ,GAAG,CAACa,KAAzC;QACI,CAACD,WAAL,EAAkB,OAAOH,IAAI,EAAX;UAEZ;MAAEK,MAAF;MAAUC,MAAV;MAAkBC;QAAchB,GAAtC;UACMiB,eAAe,GAAGjB,GAAG,CAACkB,cAAJ,EAAxB;IAEArB,MAAM,CAACsB,KAAP,CAAa,eAAb,EAA8B;MAAET,EAAF;MAAMO,eAAN;MAAuBL;KAArD;;QACI,CAACK,eAAL,EAAsB;MACpBpB,MAAM,CAACuB,IAAP,CAAY,8BAAZ,EAA4C;QAAEH;OAA9C;aACOR,IAAI,EAAX;;;UAGIvB,YAAY,GAAGN,GAAG,CAACqC,eAAD,CAAH,CAAqBI,GAArB,CAAyBT,WAAzB,CAArB;QACI,CAAC1B,YAAL,EAAmB,OAAOuB,IAAI,EAAX;IAInBV,MAAM,CAACC,GAAD,EAF6B;MAAEU,EAAF;MAAMI,MAAN;MAAcC,MAAd;MAAsBC;KAEnD,EAAoB9B,YAApB,CAAN;GAlBF;CAHF;;;;"}