{"version":3,"sources":["../../src/bot/Bot.js"],"names":["RtmClient","WebClient","CLIENT_EVENTS","Logger","compose","EventEmitter","createContextFromBot","createContextFromEvent","createContextFromHttp","INTERACTIVE_MESSAGE_RESPONSE","logger","Bot","constructor","data","middlewares","internalEventEmitter","Object","assign","_ctx","use","middleware","debug","name","push","on","allMiddlewares","middlewareLength","length","callback","toString","rtm","event","messageReceived","type","ctx","emit","start","RTM","AUTHENTICATED","self","id","debugSuccess","RTM_CONNECTION_OPENED","infoSuccess","process","send","close","removeAllListeners","disconnect","webClient","installerUsersWebClients"],"mappings":"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","file":"Bot.js","sourcesContent":["/* @flow */\nimport { RtmClient, WebClient, CLIENT_EVENTS } from '@slack/client';\nimport Logger from 'nightingale-logger';\nimport compose from 'koa-compose';\nimport { EventEmitter } from 'events';\nimport createContextFromBot from './context/createContextFromBot';\nimport createContextFromEvent from './context/createContextFromEvent';\nimport createContextFromHttp from './context/createContextFromInteractiveMessageResponse';\nimport type { MiddlewareType } from './types';\nimport type { TeamType } from '../types';\nimport { INTERACTIVE_MESSAGE_RESPONSE } from '../index';\n\ntype BotConstructorArguments = {|\n  team: ?TeamType,\n  rtm: RtmClient,\n  webClient: WebClient,\n  installerUsersWebClients: null | Map<string, WebClient>,\n|};\n\nconst logger = new Logger('koack:bot');\n\nexport default class Bot {\n  team: ?TeamType;\n  rtm: RtmClient;\n  webClient: WebClient;\n  installerUsersWebClients: null | Map<string, WebClient>;\n  middlewares: Array<MiddlewareType> = [];\n  /** bot id in the team */\n  id: ?string;\n  /** bot name in the team */\n  name: ?string;\n  internalEventEmitter = new EventEmitter();\n\n  constructor(data: BotConstructorArguments) {\n    Object.assign(this, data);\n    this._ctx = createContextFromBot(this);\n  }\n\n  use(middleware: MiddlewareType) {\n    logger.debug('use middleware', { name: middleware.name });\n    this.middlewares.push(middleware);\n  }\n\n  on(name: string | any, ...middlewares: Array<MiddlewareType>) {\n    const allMiddlewares = [...this.middlewares, ...middlewares];\n    logger.debug('register middlewares on event', { name, middlewareLength: allMiddlewares.length });\n    const callback = compose(allMiddlewares);\n\n    if (typeof name === 'symbol') {\n      this.internalEventEmitter.on(name.toString(), callback);\n      return;\n    }\n\n    this.rtm.on(name, (event: Object) => {\n      logger.debug('event', { name, event });\n      callback(createContextFromEvent(this._ctx, event));\n    });\n  }\n\n  messageReceived({ type, name, data }) {\n    if (type === 'event') {\n      if (name === INTERACTIVE_MESSAGE_RESPONSE.toString()) {\n        const ctx = createContextFromHttp(this._ctx, data);\n        this.internalEventEmitter.emit(name, ctx);\n      }\n    }\n  }\n\n  start() {\n    this.rtm.on(CLIENT_EVENTS.RTM.AUTHENTICATED, ({ self }) => {\n      this.id = self.id;\n      this.name = self.name;\n      logger.debugSuccess('authenticated', { id: self.id, name: self.name });\n    });\n    this.rtm.on(CLIENT_EVENTS.RTM.RTM_CONNECTION_OPENED, () => {\n      logger.infoSuccess('connection opened', { id: this.id, name: this.name });\n      if (process.send) process.send('ready');\n    });\n    this.rtm.start();\n    return this;\n  }\n\n  close() {\n    this.rtm.removeAllListeners();\n    this.rtm.disconnect();\n    delete this.rtm;\n    delete this.webClient;\n    delete this.installerUsersWebClients;\n  }\n}\n"]}