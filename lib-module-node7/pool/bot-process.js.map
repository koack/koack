{"version":3,"sources":["../../src/pool/bot-process.js"],"names":["Logger","createBot","logger","id","Number","process","argv","initBot","require","default","setContext","teams","Map","on","message","error","type","team","Error","bot","set","teamId","has","warn","get","close"],"mappings":"AACA,OAAO,yBAAP;AACA,OAAOA,MAAP;AACA,SAASC,SAAT,QAA0B,QAA1B;;;AAIA,MAAMC,SAAS,IAAIF,MAAJ,CAAW,YAAX,CAAf;;AAEA,MAAMG,KAAaC,OAAOC,QAAQC,IAAR,CAAa,CAAb,CAAP,CAAnB;AACA;AACA,MAAMC,UAAoBC,QAAQH,QAAQC,IAAR,CAAa,CAAb,CAAR,EAAyBG,OAAnD;;AAEAP,OAAOQ,UAAP,CAAkB,EAAEP,EAAF,EAAlB;;AAEA,MAAMQ,QAAuB,IAAIC,GAAJ,EAA7B;;AAEAP,QAAQQ,EAAR,CAAW,SAAX,EAAsBC,WAAW;AAC/B,MAAI,OAAOA,OAAP,KAAmB,QAAvB,EAAiC;AAC/BZ,WAAOa,KAAP,CAAa,oBAAb,EAAmCD,OAAnC;AACD;;AAED,UAAQA,QAAQE,IAAhB;AACE,SAAK,OAAL;AAAc;AACZ,cAAM,EAAEC,IAAF,KAA+BH,OAArC;AACA,YAAI,CAACG,KAAKd,EAAV,EAAc,MAAM,IAAIe,KAAJ,CAAU,iBAAV,CAAN;;AAEd,cAAMC,MAAMlB,UAAUgB,IAAV,CAAZ;AACAN,cAAMS,GAAN,CAAUH,KAAKd,EAAf,EAAmBgB,GAAnB;AACAZ,gBAAQY,GAAR;;AAEA;AACD;;AAED,SAAK,QAAL;AAAe;AACb,cAAM,EAAEE,MAAF,KAAiCP,OAAvC;AACA,YAAI,CAACH,MAAMW,GAAN,CAAUD,MAAV,CAAL,EAAwB;AACtBnB,iBAAOqB,IAAP,CAAY,oBAAZ,EAAkC,EAAEF,MAAF,EAAlC;AACA;AACD;;AAED,cAAMF,MAAWR,MAAMa,GAAN,CAAUH,MAAV,CAAjB;AACAF,YAAIM,KAAJ;AACA;AACD;;AAED;AAAS;AACPvB,eAAOqB,IAAP,CAAY,qBAAZ,EAAmCT,OAAnC;AACD;AA1BH;AA4BD,CAjCD","file":"bot-process.js","sourcesContent":["/* @flow */\nimport 'nightingale-app-console';\nimport Logger from 'nightingale-logger/src';\nimport { createBot } from '../bot';\nimport type Bot from '../bot/Bot';\nimport type { TeamType } from '../types';\n\nconst logger = new Logger('koack:pool');\n\nconst id: number = Number(process.argv[2]);\n// eslint-disable-next-line import/no-dynamic-require\nconst initBot: Function = require(process.argv[3]).default;\n\nlogger.setContext({ id });\n\nconst teams: Map<any, Bot> = new Map();\n\nprocess.on('message', message => {\n  if (typeof message !== 'object') {\n    logger.error('Unexpected message', message);\n  }\n\n  switch (message.type) {\n    case 'start': {\n      const { team }: { team: TeamType } = message;\n      if (!team.id) throw new Error('Invalid team.id');\n\n      const bot = createBot(team);\n      teams.set(team.id, bot);\n      initBot(bot);\n\n      break;\n    }\n\n    case 'remove': {\n      const { teamId }: { teamId: string } = message;\n      if (!teams.has(teamId)) {\n        logger.warn('Unexpected team id', { teamId });\n        return;\n      }\n\n      const bot: Bot = teams.get(teamId);\n      bot.close();\n      break;\n    }\n\n    default: {\n      logger.warn('Unsupported message', message);\n    }\n  }\n});\n"]}